<html>
<head>
<title>Entity Tester</title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.15.4/dist/bootstrap-table.min.css">

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<script src="https://unpkg.com/bootstrap-table@1.15.4/dist/bootstrap-table.min.js"></script>
<script src="https://kit.fontawesome.com/78b33735a0.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script></head>
<body>

<div class="container">

  
  <div class="row">
     <h1>Entities</h1>
  </div>

     <div class="form-group">
	      <div class="row mb-3">
	        <div class="col-12">
	        	<select id="template" name="template" class="form-control"></select>
	        </div>
	     </div>
	      <div class="row mb-3">
	      	<div id="tableholder" class="col-12">
	        </div>
	      </div>
	      <div class="row mb-3">
	        <div class="col-12">
	       <h3>CSV Import</h3>
	       <div id="importFields" class="col-6">
	       		 <div class="columns">
		       		  <div class="column">
		       		  	<label>Column <span class="columnNumber"></span></label> <select class="orderedFields" name="templateFields"></select>
		       		  	<button style="float: right;" id="addColumn" type="button" class="btn btn-success">Add Column</button>
		       		  </div>
	       			  
	       		 </div>
	       		
	       </div>
	        <br>
	        <div class="col-6">
	        	<form id="uploadForm" enctype="multipart/form-data" action="/app/upload" method="post">
		    		<input type="hidden" id="orderedFields" name="orderedFields" value="">
		    		<label>Quote Character</label>
		    		<input type="text" maxlength="1" name="quoteChar" value="&quot"><br>
		    		<label>Delimiter Character</label>
		    		<input type="text" maxlength="1" name="delimiterChar" value=","><br>
		    		<label>Contains Headers</label>&nbsp;<input type="checkbox" name="containsHeader" value="true"><br>
		    		<label>Spaces Need Quotes</label>&nbsp;<input type="checkbox" name="surroundingSpacesNeedQuotes" value="true"><br>
		    		<label>Ignore Empty Lines</label>&nbsp;<input type="checkbox" name="ignoreEmptyLines" checked value="true"><br>
		    		
		    		<input id="image-file" type="file" name="file"/>	
		    		<button id="importButton" style="float: right;" class="btn btn-success">Import</button>
				</form>
	        </div>

	        </div>
	     </div>
     </div>
</div>
<div id="json" class="modal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Entity</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
	     	<div class="col-12">
	       	 	<textarea id="jsonContent" style="width: 100%; height: 400px;" class="form-control"></textarea>
	       	 </div>
      </div>
      <div class="modal-footer">
        <button id="save" type="button" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>

$(document).ready(function() {

	$('#template').change(function() {
		debugger;
		var t = $("#template option:selected").data('template');
		if(t) {
		
			var columns = [];
			columns.push({
					title: 'UUID',
					field: 'uuid'
				});
			
			$('select[name="templateFields"]').empty();
			
			$('select[name="templateFields"]').append('<option value="">&lt;Unused&gt;</option>');
			$('select[name="templateFields"]').append('<option value="UUID">UUID</option>');

			$.each(t.fields, function(idx, obj) {
				if(!obj.hidden && (obj.fieldType==='TEXT' || obj.fieldType==="NUMBER" || obj.fieldType==="DECIMAL")) {
					columns.push({
						title: obj.name,
						field: obj.resourceKey
					});
				}
				$('select[name="templateFields"]').append('<option value="' + obj.resourceKey + '">' + obj.name + "</option>");
			});
			
			$('.columnNumber').each(function(idx) {
				$(this).text(idx+1);
			});
			
			columns.push({
				title: 'Actions',
				formatter: function(val, obj) {
					var ret = '<a class="clickEdit" href="#" data-uuid="' + obj.uuid + '"><i class="far fa-edit"></i></a>&nbsp;';
					if(!obj.system) {
						ret += '<a class="clickDelete" href="#" data-uuid="' + obj.uuid + '"><i class="far fa-trash-alt"></i></a>';
					}
					return ret;
				}
			});
			debugger;
			$('#tableholder').empty();
			$('#tableholder').append('<table id="table"></table>');
			$('#table').bootstrapTable({
				sidePagination: 'server',
				totalField: 'total',
				dataField: 'result',
				url: '/api/' + t.resourceKey + '/table',
				pagination: true,
				columns: columns,
				search: true,
				queryParams: function(params) {
					params['searchField'] = $('#searchField').val();
					return params;
				}
			});
			
			$('#table').off('post-header.bs.table');
			$('#table').on('post-header.bs.table', function(e) {
				
				if($('#searchField').length == 0) {
					$('.search').parent().append('<div class="float-right btn-group"><select id="searchField"></select></div>');
					
					$('#searchField').append('<option value="uuid">UUID</option>');
					
					$.each(t.fields, function(idx, obj) {
						$('#searchField').append('<option value="' + obj.resourceKey + '">' + obj.name + '</option>');
					});
				}
				
				$('.clickEdit').off('click');
				$('.clickDelete').off('click');
				
				$('.clickEdit').on('click', function(e) {
					e.preventDefault();
					var uuid = $(this).data('uuid');
					
					$('#save').off('click');
					$('#save').on('click', function(e) {
						$.ajax({
				            url: '/api/' + t.uuid,
				            type: 'post',
				            dataType: 'json',
				            contentType: 'application/json',
				            success: function (data) {
				            	if(data.success) {
				            		$('#table').bootstrapTable('refresh');
				            		$('#json').modal('hide');
				            	} else {
				            		alert(data.message);
				            	}
				            },
				            data: $('#jsonContent').val()
				        });
					});
					
					$('#jsonContent').val('');
					var uri = '/api/' + t.uuid + '/';
					if(t.type !== 'SINGLETON') {
						url += uuid;
					} 
					debugger;
					$.getJSON(uri, function(data) {
						if(data.success) {
							$('#jsonContent').val(JSON.stringify(data.result, null, 4));
							$('#json').modal('show');
						} else {
							alert(data.message);
						}
					});
					
					
				});
				
				$('.clickDelete').on('click', function(e) {
					e.preventDefault();
					var uuid = $(this).data('uuid');
					bootbox.confirm({
					    message: "Are you sure you want to delete the entity with uuid " + uuid + "?",
					    buttons: {
					        confirm: {
					            label: 'Yes',
					            className: 'btn-success'
					        },
					        cancel: {
					            label: 'No',
					            className: 'btn-danger'
					        }
					    },
					    callback: function (result) {
					        if(result) {
					        	var url = '/api/' + t.uuid + '/' + uuid;
					    		
					    		$.ajax({
					                url: url,
					                type: 'delete',
					                dataType: 'json',
					                success: function (data) {
					                	$('#table').bootstrapTable('refresh');
					                }
					            });
					        }
					    }
					});
				});

			});
			
			$('#addColumn').off('click');
			$('#addColumn').on('click', function(e) {
				var column = $('.column').length+1;
				$('.columns').append('<div id="c' + column + '" class="column"><label>Column <span class="columnNumber"></span></label> <select class="orderedFields" id="templateFields' + column + '"><option value="">&lt;Unused&gt;</option><option value="UUID">UUID</option></select>&nbsp;<a href="#" id="d' + column + '">x</a></div>');
				$.each(t.fields, function(idx, obj) {
					$('select[id="templateFields' + column  + '"]').append('<option value="' + obj.resourceKey + '">' + obj.name + "</option>");
				});
				$('.columnNumber').each(function(idx) {
					$(this).text(idx+1);
				});
				$('#d' + column).click(function(e) {
					$('#c' + column).remove();
					$('.columnNumber').each(function(idx) {
						$(this).text(idx+1);
					});
				});
			});
			
			$('#addButton').off('click');
			
			if(t.type !== 'SINGLETON') {
				$('#addButton').show();
				
				$('#addButton').on('click', function(e) {
					
					$('#save').off('click');
					$('#save').on('click', function(e) {
						$.ajax({
				            url: '/api/' + t.uuid,
				            type: 'post',
				            dataType: 'json',
				            contentType: 'application/json',
				            success: function (data) {
				            	if(data.success) {
				            		$('#table').bootstrapTable('refresh');
				            		$('#json').modal('hide');
				            	} else {
				            		alert(data.message);
				            	}
				            },
				            data: $('#jsonContent').val()
				        });
					});
					
					$('#jsonContent').val('');
					$('#json').modal('show');

				});
			} else {
				$('#addButton').hide();
			}
			
			$('#importButton').off('click');
			$('#importButton').on('click', function(e) {
				e.preventDefault();
				debugger;
				var orderedFields = '';
				$('.orderedFields').each(function(idx) {
					if(idx > 0) {
						orderedFields += ',';
					}
					orderedFields += $(this).val();
				});
				debugger;
				$('#orderedFields').val(orderedFields);
				$('#uploadForm').attr('action', "/upload/entity/" + t.uuid);
				$('#uploadForm').submit();
			});
			
		}
	});
	
	$.getJSON('/api/template/list', function(data) {
		
		if(data.success) {
			$.each(data.result, function(idx, obj) {
				debugger;
				$('#template').append('<option id="' + obj.uuid + '" value="' + obj.uuid + '">' + obj.name + '</option>');
				$('#' + obj.uuid).data('template', obj);
				if(idx==0) {
					$('#template').trigger('change');
				}
			});
		} else {
			alert(data.message);
		}
	});

	
// 	$('#postButton').click(function(e) {
		
// 		debugger;
// 		var t = $("#template option:selected" ).data('template');
// 		var url = '/api/' + t.uuid;
		
// 		$.ajax({
//             url: url,
//             type: 'post',
//             dataType: 'json',
//             contentType: 'application/json',
//             success: function (data) {
//             	if(data.success) {
//             		alert('Object successfully posted');
//             	} else {
//             		alert(data.message);
//             	}
//             },
//             data: $('#json').val()
//         });
// 	});
	
// 	$('#deleteButton').click(function(e) {
		
// 		debugger;
// 		var t = $("#template option:selected" ).data('template');
// 		var url = '/api/' + t.uuid + '/' + $('#uuid option:selected').val();
		
// 		$.ajax({
//             url: url,
//             type: 'delete',
//             dataType: 'json',
//             success: function (data) {
//             	if(data.success) {
//             		alert('Object successfully deleted');
//             		$('#template').trigger('change');
//             	} else {
//             		alert(data.message);
//             	}
//             }
//         });
// 	});
	
});




</script>
</body>
</html>