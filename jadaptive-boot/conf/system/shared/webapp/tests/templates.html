<!doctype html>
<html>
<head>
<title>Template Tester</title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.15.4/dist/bootstrap-table.min.css">

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<script src="https://unpkg.com/bootstrap-table@1.15.4/dist/bootstrap-table.min.js"></script>
<script src="https://kit.fontawesome.com/78b33735a0.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script>
</head>
<body>

<div class="container">

  
  <div class="row">
     <h1>Templates</h1>
  </div>
  <form>
     <div class="form-group">
	     <div class="row mb-3">
	        <div class="col-12">
	        	<table id="table" data-toggle="table" 
					  data-pagination="true"
					  data-side-pagination="server"
					  data-total-field="total"
					  data-data-field="result"
					  data-url="/api/template/table">
			      <thead>
			        <tr>
			          <th data-field="uuid">UUID</th>
			          <th data-field="name">Name</th>
			          <th data-field="type">Type</th>
			          <th data-field="system" data-formatter="renderSystem">System</th>
			          <th data-field="hidden" data-formatter="renderHidden">Hidden</th>
			          <th data-formatter="renderActions">Actions</th>
			        </tr>
			      </thead>
			      <tbody>
			      </tbody>
			    </table>
	        </div>
	     </div>
	     <div class="row mb-3">
	        <div class="col-12">
	           <button id="addButton" type="button" class="btn btn-success">Add</button>
	        </div>
	     </div>
     </div>
     
     
  </form>
</div>
<div id="json" class="modal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Template</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
	     	<div class="col-12">
	       	 	<textarea id="jsonContent" style="width: 100%; height: 400px;" class="form-control"></textarea>
	       	 </div>
      </div>
      <div class="modal-footer">
        <button id="save" type="button" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>

function renderSystem(val, obj, idx) {
	if(val) {
		return '<i class="fas fa-check"></i>';
	} else {
		return '';
	}
}

function renderHidden(val, obj, idx) {
	if(val) {
		return '<i class="fas fa-check"></i>';
	} else {
		return '';
	}
}

function renderActions(val, obj, idx) {
	var ret = '<a class="clickEdit" href="#" data-uuid="' + obj.uuid + '"><i class="far fa-edit"></i></a>&nbsp;'	
	if(!obj.system) {
		ret += '<a class="clickDelete" href="#" data-uuid="' + obj.uuid + '"><i class="far fa-trash-alt"></i></a>';
	}
	return ret;
}

$(document).ready(function() {

	
	$('#table').on('post-header.bs.table', function(e) {
		$('.clickEdit').off('click');
		$('.clickDelete').off('click');
		

		
		$('.clickEdit').on('click', function(e) {
			e.preventDefault();
			var uuid = $(this).data('uuid');
			
			$('#save').off('click');
			$('#save').on('click', function(e) {
				$.ajax({
		            url: '/api/template',
		            type: 'post',
		            dataType: 'json',
		            contentType: 'application/json',
		            success: function (data) {
		            	if(data.success) {
		            		$('#table').bootstrapTable('refresh');
		            		$('#json').modal('hide');
		            	} else {
		            		alert(data.message);
		            	}
		            },
		            data: $('#jsonContent').val()
		        });
			});
			
			$('#jsonContent').val('');
			$.getJSON('/api/template/' + uuid, function(data) {
				if(data.success) {
					$('#jsonContent').val(JSON.stringify(data.resource, null, 4));
					$('#json').modal('show');
				} else {
					alert(data.message);
				}
			});
			
			
		});
		
		$('.clickDelete').on('click', function(e) {
			e.preventDefault();
			var uuid = $(this).data('uuid');
			bootbox.confirm({
			    message: "Are you sure you want to delete the " + uuid + " template?",
			    buttons: {
			        confirm: {
			            label: 'Yes',
			            className: 'btn-success'
			        },
			        cancel: {
			            label: 'No',
			            className: 'btn-danger'
			        }
			    },
			    callback: function (result) {
			        if(result) {
			        	var url = '/api/template/' + uuid;
			    		
			    		$.ajax({
			                url: url,
			                type: 'delete',
			                dataType: 'json',
			                success: function (data) {
			                	$('#table').bootstrapTable('refresh');
			                }
			            });
			        }
			    }
			});
		});
	});

	
	$('#addButton').click(function(e) {
		
		$('#save').off('click');
		$('#save').on('click', function(e) {
			$.ajax({
	            url: '/api/template',
	            type: 'post',
	            dataType: 'json',
	            contentType: 'application/json',
	            success: function (data) {
	            	if(data.success) {
	            		$('#table').bootstrapTable('refresh');
	            		$('#json').modal('hide');
	            	} else {
	            		alert(data.message);
	            	}
	            },
	            data: $('#jsonContent').val()
	        });
		});
		
		$('#jsonContent').val('');
		$('#json').modal('show');

	});
});




</script>
</body>
</html>